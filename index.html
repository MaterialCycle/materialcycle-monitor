<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MaterialCycle Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <h1 class="text-4xl font-bold mb-8">MaterialCycle Monitor</h1>

  <!-- Nav Buttons -->
  <div class="mb-6 space-x-4">
    <button id="showTowerSetup" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Tower Setup</button>
    <button id="showDailyLog" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Daily Log Entry</button>
  </div>

  <!-- Tower Setup Section -->
  <section id="towerSetupSection" class="mb-12">
    <h2 class="text-2xl font-semibold mb-4">Tower Setup</h2>
    <form id="towerForm" class="space-y-4 max-w-xl bg-white p-6 rounded shadow">
      <label>
        Tower Name:
        <input type="text" id="towerName" placeholder="Optional" class="border p-2 w-full" />
      </label>
      <label>
        Tower Type:
        <select id="towerType" class="border p-2 w-full" required>
          <option value="">Select type</option>
          <option value="plant">Plant</option>
          <option value="distillation">Distillation</option>
          <option value="hybrid">Hybrid</option>
        </select>
      </label>
      <label>
        Location:
        <input type="text" id="towerLocation" placeholder="e.g. Backyard near fence" class="border p-2 w-full" />
      </label>
      <label>
        Latitude:
        <input type="number" id="towerLat" step="0.000001" placeholder="e.g. -33.923" class="border p-2 w-full" />
      </label>
      <label>
        Longitude:
        <input type="number" id="towerLng" step="0.000001" placeholder="e.g. 18.417" class="border p-2 w-full" />
      </label>
      <label>
        Default Water Source:
        <select id="towerWaterSource" class="border p-2 w-full">
          <option value="rainwater">Rainwater</option>
          <option value="tap">Tap</option>
          <option value="greywater">Greywater</option>
          <option value="other">Other</option>
        </select>
      </label>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Tower</button>
    </form>

    <h3 class="mt-8 text-xl font-semibold">Saved Towers</h3>
    <ul id="towerList" class="mt-2 space-y-2 max-w-xl"></ul>
  </section>

  <!-- Daily Log Section -->
  <section id="dailyLogSection" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">Daily Log Entry</h2>
    <form id="dailyLogForm" class="space-y-4 max-w-3xl bg-white p-6 rounded shadow overflow-auto max-h-[80vh]">
      <label>
        Tower:
        <select id="towerSelect" required class="border p-2 w-full"></select>
      </label>

      <label>
        Date:
        <input type="date" id="logDate" required class="border p-2 w-full" />
      </label>

      <!-- Photos Upload -->
      <div>
        <label>Before Photo:</label>
        <input type="file" id="photoBefore" accept="image/*" />
        <img id="previewBefore" class="mt-2 max-h-40" />
      </div>

      <div>
        <label>After Photo:</label>
        <input type="file" id="photoAfter" accept="image/*" />
        <img id="previewAfter" class="mt-2 max-h-40" />
      </div>

      <div>
        <label>Sunlight Start Photo:</label>
        <input type="file" id="photoSunlightStart" accept="image/*" />
        <img id="previewSunlightStart" class="mt-2 max-h-40" />
      </div>

      <div>
        <label>Sunlight End Photo:</label>
        <input type="file" id="photoSunlightEnd" accept="image/*" />
        <img id="previewSunlightEnd" class="mt-2 max-h-40" />
      </div>

      <label>
        Sunlight Start Time:
        <input type="time" id="sunlightStartTime" />
      </label>

      <label>
        Sunlight End Time:
        <input type="time" id="sunlightEndTime" />
      </label>

      <label>
        Calculated Sunlight Hours:
        <input type="number" id="sunlightHours" step="0.01" readonly class="bg-gray-200" />
      </label>

      <label>
        Manual Override Sunlight Hours:
        <input type="number" id="sunlightHoursManual" step="0.01" min="0" max="24" />
      </label>

      <label>
        Exposure Type:
        <select id="exposureType" class="border p-2 w-full">
          <option>Full Sun</option>
          <option>Partial Sun</option>
          <option>Reflected</option>
          <option>Artificial</option>
          <option>No Sun</option>
        </select>
      </label>

      <!-- Water Section -->
      <fieldset class="border p-3">
        <legend class="font-semibold">Water</legend>
        <label>
          Water Level (L):
          <input type="number" id="waterLevel" step="0.1" min="0" />
        </label>
        <label>
          Water Added Today (L):
          <input type="number" id="waterAdded" step="0.1" min="0" />
        </label>
        <label>
          Water Source:
          <select id="waterSource" class="border p-2 w-full">
            <option>Rainwater</option>
            <option>Tap</option>
            <option>Greywater</option>
            <option>Other</option>
          </select>
        </label>
        <label>
          Overflow:
          <input type="text" id="overflow" />
        </label>
        <label>
          Rainfall Observed:
          <select id="rainfallObserved" class="border p-2 w-full">
            <option>Yes</option>
            <option>No</option>
          </select>
        </label>
        <label>
          Notes:
          <textarea id="waterNotes" rows="2" class="border p-2 w-full"></textarea>
        </label>
      </fieldset>

      <!-- Distillation Section -->
      <fieldset class="border p-3">
        <legend class="font-semibold">Distillation</legend>
        <label>
          Raw Input Type:
          <input type="text" id="rawInputType" />
        </label>
        <label>
          Input Volume (L):
          <input type="number" id="inputVolume" step="0.1" min="0" />
        </label>
        <label>
          Distilled Volume (L):
          <input type="number" id="distilledVolume" step="0.1" min="0" />
        </label>
      </fieldset>

      <!-- Biomass Section -->
      <fieldset class="border p-3">
        <legend class="font-semibold">Biomass</legend>
        <label>
          Harvested (g):
          <input type="number" id="harvested" step="1" min="0" />
        </label>
        <label>
          Type:
          <input type="text" id="biomassType" />
        </label>
        <label>
          Waste Removed (g):
          <input type="number" id="wasteRemoved" step="1" min="0" />
        </label>
        <label>
          New Additions (comma separated):
          <input type="text" id="newAdditions" placeholder="e.g. compost, leaves" />
        </label>
      </fieldset>

      <!-- Maintenance Section -->
      <fieldset class="border p-3">
        <legend class="font-semibold">Maintenance</legend>
        <label>
          Issue:
          <input type="text" id="maintenanceIssue" />
        </label>
        <label>
          Action Taken:
          <input type="text" id="maintenanceAction" />
        </label>
        <label>
          Next Reminder Date:
          <input type="date" id="nextReminder" />
        </label>
      </fieldset>

      <!-- Aquatic Section -->
      <fieldset class="border p-3">
        <legend class="font-semibold">Aquatic Life</legend>
        <label>
          Fish Status:
          <input type="text" id="fishStatus" />
        </label>
        <label>
          Water Clarity:
          <input type="text" id="waterClarity" />
        </label>
        <label>
          Odor:
          <input type="text" id="odor" />
        </label>
      </fieldset>

      <!-- Weather Section -->
      <fieldset class="border p-3">
        <legend class="font-semibold">Weather</legend>
        <label>
          Summary:
          <input type="text" id="weatherSummary" />
        </label>
        <label>
          Temperature (Â°C):
          <input type="number" id="weatherTemp" step="0.1" />
        </label>
        <label>
          Rainfall (mm):
          <input type="number" id="weatherRainfall" step="0.1" />
        </label>
        <label>
          Pulled From Location:
          <select id="weatherPulled" class="border p-2 w-full">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </label>
      </fieldset>

      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save Log</button>
    </form>
  </section>

  <script type="module">
    // IndexedDB helper - simplified for demo
    const DB_NAME = 'MaterialCycleDB';
    const DB_VERSION = 1;
    let db;

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = e => {
          db = e.target.result;
          if (!db.objectStoreNames.contains('towers')) {
            db.createObjectStore('towers', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('logs')) {
            db.createObjectStore('logs', { keyPath: 'id' });
          }
        };
        request.onsuccess = e => {
          db = e.target.result;
          resolve(db);
        };
        request.onerror = e => reject(e.target.error);
      });
    }

    async function addTower(tower) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('towers', 'readwrite');
        const store = tx.objectStore('towers');
        store.put(tower);
        tx.oncomplete = () => resolve();
        tx.onerror = e => reject(e.target.error);
      });
    }

    async function getAllTowers() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('towers', 'readonly');
        const store = tx.objectStore('towers');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = e => reject(e.target.error);
      });
    }

    async function addLog(log) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        store.put(log);
        tx.oncomplete = () => resolve();
        tx.onerror = e => reject(e.target.error);
      });
    }

    // UI Elements
    const towerForm = document.getElementById('towerForm');
    const towerList = document.getElementById('towerList');
    const dailyLogForm = document.getElementById('dailyLogForm');
    const towerSelect = document.getElementById('towerSelect');
    const sunlightStartTime = document.getElementById('sunlightStartTime');
    const sunlightEndTime = document.getElementById('sunlightEndTime');
    const sunlightHours = document.getElementById('sunlightHours');
    const sunlightHoursManual = document.getElementById('sunlightHoursManual');

    // Navigation buttons and sections
    const showTowerSetupBtn = document.getElementById('showTowerSetup');
    const showDailyLogBtn = document.getElementById('showDailyLog');
    const towerSetupSection = document.getElementById('towerSetupSection');
    const dailyLogSection = document.getElementById('dailyLogSection');

    // Navigation
    showTowerSetupBtn.addEventListener('click', () => {
      towerSetupSection.classList.remove('hidden');
      dailyLogSection.classList.add('hidden');
    });
    showDailyLogBtn.addEventListener('click', () => {
      dailyLogSection.classList.remove('hidden');
      towerSetupSection.classList.add('hidden');
      populateTowerDropdown();
    });

    // Populate tower list below Tower Setup form
    async function refreshTowerList() {
      const towers = await getAllTowers();
      towerList.innerHTML = '';
      towers.forEach(tower => {
        const li = document.createElement('li');
        li.textContent = `${tower.name || '(No name)'} [${tower.type}] - ${tower.location || ''}`;
        towerList.appendChild(li);
      });
    }

    towerForm.addEventListener('submit', async e => {
      e.preventDefault();
      const id = 'tower-' + Date.now();
      const tower = {
        id,
        name: document.getElementById('towerName').value.trim(),
        type: document.getElementById('towerType').value,
        location: document.getElementById('towerLocation').value.trim(),
        gps: {
          lat: Number(document.getElementById('towerLat').value) || null,
          lng: Number(document.getElementById('towerLng').value) || null,
        },
        waterSource: document.getElementById('towerWaterSource').value,
        createdAt: new Date().toISOString(),
      };
      if (!tower.type) {
        alert('Please select a tower type.');
        return;
      }
      await addTower(tower);
      towerForm.reset();
      await refreshTowerList();
      alert('Tower saved!');
    });

    // Populate tower dropdown in Daily Log form
    async function populateTowerDropdown() {
      const towers = await getAllTowers();
      towerSelect.innerHTML = '<option value="">-- Select Tower --</option>';
      towers.forEach(tower => {
        const opt = document.createElement('option');
        opt.value = tower.id;
        opt.textContent = `${tower.name || '(No name)'} (${tower.type})`;
        towerSelect.appendChild(opt);
      });
    }

    // Calculate sunlight hours from start and end time inputs
    function calculateSunlightHours() {
      if (!sunlightStartTime.value || !sunlightEndTime.value) {
        sunlightHours.value = '';
        return;
      }
      const start = sunlightStartTime.value.split(':').map(Number);
      const end = sunlightEndTime.value.split(':').map(Number);
      let diff = (end[0] + end[1] / 60) - (start[0] + start[1] / 60);
      if (diff < 0) diff += 24; // handle overnight times
      sunlightHours.value = diff.toFixed(2);
    }

    sunlightStartTime.addEventListener('change', calculateSunlightHours);
    sunlightEndTime.addEventListener('change', calculateSunlightHours);

    sunlightHoursManual.addEventListener('input', () => {
      if (sunlightHoursManual.value !== '') {
        sunlightHours.value = sunlightHoursManual.value;
      } else {
        calculateSunlightHours();
      }
    });

    // Image preview helpers
    function previewImage(inputElem, imgElem) {
      const file = inputElem.files[0];
      if (!file) {
        imgElem.src = '';
        return;
      }
      const url = URL.createObjectURL(file);
      imgElem.src = url;
    }

    ['photoBefore', 'photoAfter', 'photoSunlightStart', 'photoSunlightEnd'].forEach(id => {
      const input = document.getElementById(id);
      const img = document.getElementById('preview' + id.charAt(0).toUpperCase() + id.slice(1));
      input.addEventListener('change', e => previewImage(e.target, img));
    });

    // Convert file to base64 string
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        if (!file) resolve(null);
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject('File read error');
        reader.readAsDataURL(file);
      });
    }

    dailyLogForm.addEventListener('submit', async e => {
      e.preventDefault();

      if (!towerSelect.value) {
        alert('Please select a tower.');
        return;
      }
      const beforePhotoFile = document.getElementById('photoBefore').files[0];
      const afterPhotoFile = document.getElementById('photoAfter').files[0];
      const sunlightStartPhotoFile = document.getElementById('photoSunlightStart').files[0];
      const sunlightEndPhotoFile = document.getElementById('photoSunlightEnd').files[0];

      const logEntry = {
        id: 'log-' + Date.now(),
        towerId: towerSelect.value,
        date: document.getElementById('logDate').value,
        photos: {
          before: await fileToBase64(beforePhotoFile),
          after: await fileToBase64(afterPhotoFile),
          sunlightStart: await fileToBase64(sunlightStartPhotoFile),
          sunlightEnd: await fileToBase64(sunlightEndPhotoFile),
        },
        sunlight: {
          startTime: sunlightStartTime.value || null,
          endTime: sunlightEndTime.value || null,
          hours: Number(sunlightHours.value) || 0,
          exposureType: document.getElementById('exposureType').value,
          autoEstimate: sunlightHoursManual.value === '' // true if no manual override
        },
        water: {
          waterLevel: Number(document.getElementById('waterLevel').value) || 0,
          addedToday: Number(document.getElementById('waterAdded').value) || 0,
          sourceUsed: document.getElementById('waterSource').value,
          overflow: document.getElementById('overflow').value.trim(),
          rainfallObserved: document.getElementById('rainfallObserved').value,
          notes: document.getElementById('waterNotes').value.trim()
        },
        distillation: {
          rawInputType: document.getElementById('rawInputType').value.trim(),
          inputVolume: Number(document.getElementById('inputVolume').value) || 0,
          distilledVolume: Number(document.getElementById('distilledVolume').value) || 0
        },
        biomass: {
          harvested: Number(document.getElementById('harvested').value) || 0,
          type: document.getElementById('biomassType').value.trim(),
          wasteRemoved: Number(document.getElementById('wasteRemoved').value) || 0,
          newAdditions: document.getElementById('newAdditions').value.split(',').map(s => s.trim()).filter(s => s)
        },
        maintenance: {
          issue: document.getElementById('maintenanceIssue').value.trim(),
          action: document.getElementById('maintenanceAction').value.trim(),
          nextReminder: document.getElementById('nextReminder').value || null
        },
        aquatic: {
          fishStatus: document.getElementById('fishStatus').value.trim(),
          clarity: document.getElementById('waterClarity').value.trim(),
          odor: document.getElementById('odor').value.trim()
        },
        weather: {
          summary: document.getElementById('weatherSummary').value.trim(),
          temp: Number(document.getElementById('weatherTemp').value) || 0,
          rainfall: Number(document.getElementById('weatherRainfall').value) || 0,
          pulledFromLocation: document.getElementById('weatherPulled').value === 'true'
        },
        timestamp: new Date().toISOString()
      };

      try {
        await addLog(logEntry);
        alert('Daily log saved!');
        dailyLogForm.reset();
        sunlightHours.value = '';
        sunlightHoursManual.value = '';
      } catch (err) {
        alert('Error saving log: ' + err.message);
      }
    });

    // Init
    window.addEventListener('DOMContentLoaded', async () => {
      await refreshTowerList();
      document.getElementById('logDate').valueAsDate = new Date();
      // Show Tower Setup by default
      towerSetupSection.classList.remove('hidden');
      dailyLogSection.classList.add('hidden');
    });
  </script>
</body>
</html>
