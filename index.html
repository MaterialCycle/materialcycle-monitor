<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MaterialCycle Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
  input, select, button, textarea { margin: 5px 0; padding: 8px; width: 100%; box-sizing: border-box; }
  section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
  h2 { margin-top: 0; }
  label { font-weight: bold; display: block; margin-top: 10px; }
</style>
</head>
<body>
  <h1>MaterialCycle Monitor</h1>

  <!-- Tower Setup -->
  <section id="towerSetup">
    <h2>Tower Setup</h2>
    <label for="towerName">Tower Name</label>
    <input id="towerName" type="text" placeholder="Enter tower name" />

    <label for="towerType">Tower Type</label>
    <select id="towerType">
      <option value="plant">Plant</option>
      <option value="distillation">Distillation</option>
      <option value="hybrid">Hybrid</option>
    </select>

    <label for="towerLocation">Location</label>
    <input id="towerLocation" type="text" placeholder="Enter location" />

    <label for="towerWaterSource">Water Source</label>
    <select id="towerWaterSource">
      <option value="rainwater">Rainwater</option>
      <option value="tap">Tap</option>
      <option value="greywater">Greywater</option>
    </select>

    <button id="saveTowerBtn">Save Tower</button>

    <h3>Saved Towers</h3>
    <ul id="towerList"></ul>
  </section>

  <!-- Daily Log Entry -->
  <section id="dailyLog">
    <h2>Daily Log Entry</h2>

    <label for="logTowerSelect">Select Tower</label>
    <select id="logTowerSelect"></select>

    <label for="logDate">Date</label>
    <input id="logDate" type="date" />

    <!-- Photos -->
    <label>Upload Before Photo</label>
    <input id="photoBefore" type="file" accept="image/*" />

    <label>Upload After Photo</label>
    <input id="photoAfter" type="file" accept="image/*" />

    <label>Upload Sunlight Start Photo</label>
    <input id="photoSunlightStart" type="file" accept="image/*" />

    <label>Upload Sunlight End Photo</label>
    <input id="photoSunlightEnd" type="file" accept="image/*" />

    <!-- Sunlight -->
    <label for="sunlightStart">Sunlight Start Time</label>
    <input id="sunlightStart" type="time" />

    <label for="sunlightEnd">Sunlight End Time</label>
    <input id="sunlightEnd" type="time" />

    <label for="sunlightExposure">Exposure Type</label>
    <select id="sunlightExposure">
      <option value="Full Sun">Full Sun</option>
      <option value="Partial Sun">Partial Sun</option>
      <option value="Reflected">Reflected</option>
      <option value="Artificial">Artificial</option>
      <option value="No Sun">No Sun</option>
    </select>

    <!-- Water -->
    <label for="waterLevel">Water Level (L)</label>
    <input id="waterLevel" type="number" step="0.1" min="0" />

    <label for="waterAdded">Water Added Today (L)</label>
    <input id="waterAdded" type="number" step="0.1" min="0" />

    <label for="waterSourceLog">Water Source Used</label>
    <select id="waterSourceLog">
      <option value="rainwater">Rainwater</option>
      <option value="tap">Tap</option>
      <option value="greywater">Greywater</option>
    </select>

    <label for="overflow">Overflow</label>
    <input id="overflow" type="text" placeholder="None / Yes / Describe" />

    <label for="rainfallObserved">Rainfall Observed</label>
    <select id="rainfallObserved">
      <option value="No">No</option>
      <option value="Yes">Yes</option>
    </select>

    <label for="waterNotes">Water Notes</label>
    <textarea id="waterNotes" rows="2" placeholder="Water quality notes..."></textarea>

    <!-- Distillation -->
    <label for="rawInputType">Raw Water Type</label>
    <input id="rawInputType" type="text" placeholder="e.g. greywater" />

    <label for="inputVolume">Raw Input Volume (L)</label>
    <input id="inputVolume" type="number" step="0.1" min="0" />

    <label for="distilledVolume">Distilled Water Collected (L)</label>
    <input id="distilledVolume" type="number" step="0.1" min="0" />

    <!-- Biomass -->
    <label for="biomassHarvested">Biomass Harvested (g)</label>
    <input id="biomassHarvested" type="number" step="1" min="0" />

    <label for="biomassType">Biomass Type</label>
    <input id="biomassType" type="text" placeholder="e.g. Spinach" />

    <label for="wasteRemoved">Waste Removed (g)</label>
    <input id="wasteRemoved" type="number" step="1" min="0" />

    <label for="newAdditions">New Additions (comma separated)</label>
    <input id="newAdditions" type="text" placeholder="e.g. compost" />

    <!-- Maintenance -->
    <label for="maintenanceIssue">Maintenance Issue</label>
    <input id="maintenanceIssue" type="text" placeholder="e.g. Filter Dirty" />

    <label for="maintenanceAction">Action Taken</label>
    <input id="maintenanceAction" type="text" placeholder="e.g. Cleaned" />

    <label for="nextReminder">Next Reminder Date</label>
    <input id="nextReminder" type="date" />

    <!-- Aquatic -->
    <label for="fishStatus">Fish Activity</label>
    <input id="fishStatus" type="text" placeholder="e.g. Active" />

    <label for="waterClarity">Water Clarity</label>
    <input id="waterClarity" type="text" placeholder="e.g. Clear" />

    <label for="waterOdor">Water Odor</label>
    <input id="waterOdor" type="text" placeholder="e.g. None" />

    <!-- Weather -->
    <label for="weatherSummary">Weather Summary</label>
    <input id="weatherSummary" type="text" placeholder="e.g. Sunny, 25°C" />

    <label for="weatherTemp">Temperature (°C)</label>
    <input id="weatherTemp" type="number" step="0.1" />

    <label for="weatherRainfall">Rainfall (mm)</label>
    <input id="weatherRainfall" type="number" step="0.1" />

    <button id="saveLogBtn">Save Daily Log</button>
  </section>

<script type="module">
  import { addTower, getAllTowers } from './js/db.js';
  import { addTowerRecord, fetchTowers } from './js/towers.js';
  import { addLogRecord } from './js/logs.js';

  // Tower Setup

  async function refreshTowerList() {
    const towers = await fetchTowers();
    const listEl = document.getElementById('towerList');
    listEl.innerHTML = '';
    if (towers.length === 0) {
      listEl.innerHTML = '<li>No towers saved yet.</li>';
      return;
    }
    towers.forEach(t => {
      const li = document.createElement('li');
      li.textContent = `${t.name} (${t.type}) - ${t.location} [${t.waterSource}]`;
      listEl.appendChild(li);
    });
  }

  async function refreshTowerDropdown() {
    const towers = await fetchTowers();
    const select = document.getElementById('logTowerSelect');
    select.innerHTML = '<option value="">-- Select Tower --</option>';
    towers.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.name;
      select.appendChild(opt);
    });
  }

  document.getElementById('saveTowerBtn').addEventListener('click', async () => {
    const tower = {
      id: 'tower-' + Date.now(),
      name: document.getElementById('towerName').value.trim(),
      type: document.getElementById('towerType').value,
      location: document.getElementById('towerLocation').value.trim(),
      waterSource: document.getElementById('towerWaterSource').value,
      createdAt: new Date().toISOString()
    };

    if (!tower.name) {
      alert('Please enter a tower name.');
      return;
    }

    try {
      await addTowerRecord(tower);
      alert('Tower saved!');
      document.getElementById('towerName').value = '';
      document.getElementById('towerLocation').value = '';
      await refreshTowerList();
      await refreshTowerDropdown();
    } catch (e) {
      alert('Error saving tower: ' + e.message);
    }
  });

  // Daily Log Entry

  document.getElementById('saveLogBtn').addEventListener('click', async () => {
    const towerId = document.getElementById('logTowerSelect').value;
    if (!towerId) {
      alert('Please select a tower.');
      return;
    }
    const logDate = document.getElementById('logDate').value;
    if (!logDate) {
      alert('Please select a date.');
      return;
    }

    // Helper to convert file input to base64 string
    async function fileToBase64(inputId) {
      const input = document.getElementById(inputId);
      if (!input.files || input.files.length === 0) return null;
      const file = input.files[0];
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    try {
      // Read photos asynchronously
      const photos = {
        before: await fileToBase64('photoBefore'),
        after: await fileToBase64('photoAfter'),
        sunlightStart: await fileToBase64('photoSunlightStart'),
        sunlightEnd: await fileToBase64('photoSunlightEnd')
      };

      // Calculate sunlight hours automatically
      const startTime = document.getElementById('sunlightStart').value;
      const endTime = document.getElementById('sunlightEnd').value;
      let sunlightHours = 0;
      if (startTime && endTime) {
        const start = new Date(`1970-01-01T${startTime}:00`);
        const end = new Date(`1970-01-01T${endTime}:00`);
        sunlightHours = (end - start) / 1000 / 3600;
        if (sunlightHours < 0) sunlightHours = 0;
      }

      const log = {
        id: 'log-' + Date.now(),
        towerId,
        date: logDate,
        photos,
        sunlight: {
          startTime,
          endTime,
          hours: sunlightHours,
          exposureType: document.getElementById('sunlightExposure').value,
          autoEstimate: false
        },
        water: {
          waterLevel: parseFloat(document.getElementById('waterLevel').value) || 0,
          addedToday: parseFloat(document.getElementById('waterAdded').value) || 0,
          sourceUsed: document.getElementById('waterSourceLog').value,
          overflow: document.getElementById('overflow').value.trim() || 'None',
          rainfallObserved: document.getElementById('rainfallObserved').value,
          notes: document.getElementById('waterNotes').value.trim()
        },
        distillation: {
          rawInputType: document.getElementById('rawInputType').value.trim(),
          inputVolume: parseFloat(document.getElementById('inputVolume').value) || 0,
          distilledVolume: parseFloat(document.getElementById('distilledVolume').value) || 0
        },
        biomass: {
          harvested: parseInt(document.getElementById('biomassHarvested').value) || 0,
          type: document.getElementById('biomassType').value.trim(),
          wasteRemoved: parseInt(document.getElementById('wasteRemoved').value) || 0,
          newAdditions: document.getElementById('newAdditions').value.split(',').map(s => s.trim()).filter(Boolean)
        },
        maintenance: {
          issue: document.getElementById('maintenanceIssue').value.trim(),
          action: document.getElementById('maintenanceAction').value.trim(),
          nextReminder: document.getElementById('nextReminder').value
        },
        aquatic: {
          fishStatus: document.getElementById('fishStatus').value.trim(),
          clarity: document.getElementById('waterClarity').value.trim(),
          odor: document.getElementById('waterOdor').value.trim()
        },
        weather: {
          summary: document.getElementById('weatherSummary').value.trim(),
          temp: parseFloat(document.getElementById('weatherTemp').value) || 0,
          rainfall: parseFloat(document.getElementById('weatherRainfall').value) || 0,
          pulledFromLocation: false
        },
        timestamp: new Date().toISOString()
      };

      await addLogRecord(log);
      alert('Daily log saved!');

      // Clear inputs except tower selector
      [
        'logDate','photoBefore','photoAfter','photoSunlightStart','photoSunlightEnd',
        'sunlightStart','sunlightEnd','sunlightExposure','waterLevel','waterAdded','waterSourceLog',
        'overflow','rainfallObserved','waterNotes','rawInputType','inputVolume','distilledVolume',
        'biomassHarvested','biomassType','wasteRemoved','newAdditions','maintenanceIssue','maintenanceAction',
        'nextReminder','fishStatus','waterClarity','waterOdor','weatherSummary','weatherTemp','weatherRainfall'
      ].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'file') el.value = '';
        else el.value = '';
      });

    } catch (error) {
      alert('Error saving daily log: ' + error.message);
    }
  });

  // Initial load
  (async () => {
    await refreshTowerList();
    await refreshTowerDropdown();
  })();
</script>
</body>
</html>
