<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MaterialCycle Monitor - Full Skeleton</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    nav button { margin-right: 0.5rem; padding: 0.4rem 0.8rem; }
    section { display: none; margin-top: 1rem; }
    section.active { display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.4rem; text-align: left; }
    th { background-color: #eee; }
    .btn-small { padding: 0.2rem 0.5rem; margin-right: 0.3rem; cursor: pointer; }
  </style>
</head>
<body>

  <h1>MaterialCycle Monitor</h1>

  <nav>
    <button id="navTowerSetup">Tower Setup</button>
    <button id="navDailyLog">Daily Log</button>
    <button id="navLogHistory">Log History</button>
  </nav>

  <!-- Tower Setup Section -->
  <section id="towerSetupSection" class="active">
    <h2>Tower Setup</h2>
    <form id="towerSetupForm">
      <label>
        Tower Name:
        <input type="text" id="towerName" required />
      </label><br /><br />
      <label>
        Tower Type:
        <select id="towerType" required>
          <option value="plant">Plant</option>
          <option value="distillation">Distillation</option>
          <option value="hybrid">Hybrid</option>
        </select>
      </label><br /><br />
      <label>
        Location:
        <input type="text" id="towerLocation" />
      </label><br /><br />
      <label>
        GPS Latitude:
        <input type="number" id="towerLat" step="any" />
      </label><br /><br />
      <label>
        GPS Longitude:
        <input type="number" id="towerLng" step="any" />
      </label><br /><br />
      <label>
        Default Water Source:
        <select id="towerWaterSource">
          <option value="rainwater">Rainwater</option>
          <option value="tap">Tap</option>
          <option value="well">Well</option>
        </select>
      </label><br /><br />
      <button type="submit">Save Tower</button>
    </form>

    <h3>Saved Towers</h3>
    <ul id="towerList"></ul>
  </section>

  <!-- Daily Log Section -->
  <section id="dailyLogSection">
    <h2>Daily Log Entry</h2>
    <form id="dailyLogForm">
      <label>
        Tower:
        <select id="logTowerSelect" required>
          <option value="">-- Select Tower --</option>
        </select>
      </label><br /><br />
      <label>
        Date:
        <input type="date" id="logDate" required />
      </label><br /><br />
      <label>
        Sunlight Hours:
        <input type="number" id="sunlightHours" step="0.01" min="0" />
      </label><br /><br />
      <label>
        Water Added (L):
        <input type="number" id="waterAdded" step="0.01" min="0" />
      </label><br /><br />
      <label>
        Biomass Harvested (g):
        <input type="number" id="biomassHarvested" step="0.1" min="0" />
      </label><br /><br />
      <button type="submit">Save Daily Log</button>
    </form>
  </section>

  <!-- Log History Section -->
  <section id="logHistorySection">
    <h2>Log History</h2>

    <label>
      Filter by Tower:
      <select id="filterTowerSelect">
        <option value="">All Towers</option>
      </select>
    </label>
    <label>
      From:
      <input type="date" id="filterFromDate" />
    </label>
    <label>
      To:
      <input type="date" id="filterToDate" />
    </label>
    <button id="applyFiltersBtn">Apply Filters</button>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Tower</th>
          <th>Sunlight Hours</th>
          <th>Water Added</th>
          <th>Biomass Harvested</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="logTableBody">
        <!-- Logs will be inserted here -->
      </tbody>
    </table>
  </section>

<script>
  // Utility: Show only one section at a time
  function showSection(id) {
    ['towerSetupSection','dailyLogSection','logHistorySection'].forEach(secId => {
      document.getElementById(secId).classList.toggle('active', secId === id);
    });
  }

  // Navigation button events
  document.getElementById('navTowerSetup').onclick = () => showSection('towerSetupSection');
  document.getElementById('navDailyLog').onclick = () => showSection('dailyLogSection');
  document.getElementById('navLogHistory').onclick = () => {
    showSection('logHistorySection');
    loadLogHistory();
  };

  // IndexedDB setup
  let db;
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('MaterialCycleDB', 1);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        db = request.result;
        resolve(db);
      };
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('towers')) {
          db.createObjectStore('towers', { keyPath: 'id', autoIncrement: true });
        }
        if (!db.objectStoreNames.contains('logs')) {
          const logsStore = db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
          logsStore.createIndex('towerId', 'towerId', { unique: false });
          logsStore.createIndex('date', 'date', { unique: false });
        }
      };
    });
  }

  // Add Tower
  async function addTower(tower) {
    const tx = db.transaction('towers', 'readwrite');
    const store = tx.objectStore('towers');
    await store.add(tower);
    return tx.complete;
  }

  // Get all Towers
  async function getAllTowers() {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('towers', 'readonly');
      const store = tx.objectStore('towers');
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Add Log
  async function addLog(log) {
    const tx = db.transaction('logs', 'readwrite');
    const store = tx.objectStore('logs');
    await store.add(log);
    return tx.complete;
  }

  // Get Logs with optional filters
  async function getLogs(filter = {}) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('logs', 'readonly');
      const store = tx.objectStore('logs');
      const request = store.getAll();
      request.onsuccess = () => {
        let logs = request.result;
        if (filter.towerId) {
          logs = logs.filter(l => l.towerId == filter.towerId);
        }
        if (filter.fromDate) {
          logs = logs.filter(l => l.date >= filter.fromDate);
        }
        if (filter.toDate) {
          logs = logs.filter(l => l.date <= filter.toDate);
        }
        resolve(logs);
      };
      request.onerror = () => reject(request.error);
    });
  }

  // Populate tower dropdowns
  async function populateTowerDropdowns() {
    const towers = await getAllTowers();

    const towerSelects = [document.getElementById('logTowerSelect'), document.getElementById('filterTowerSelect')];
    towerSelects.forEach(select => {
      select.innerHTML = '<option value="">-- Select Tower --</option>';
      towers.forEach(tower => {
        const opt = document.createElement('option');
        opt.value = tower.id;
        opt.textContent = tower.name || `Tower #${tower.id}`;
        select.appendChild(opt);
      });
    });

    // Also update tower list in Tower Setup section
    const towerList = document.getElementById('towerList');
    towerList.innerHTML = '';
    towers.forEach(tower => {
      const li = document.createElement('li');
      li.textContent = `${tower.name} (${tower.type}) - ${tower.location || 'No location'}`;
      towerList.appendChild(li);
    });
  }

  // Handle Tower Setup form submit
  document.getElementById('towerSetupForm').addEventListener('submit', async e => {
    e.preventDefault();
    const tower = {
      name: document.getElementById('towerName').value.trim(),
      type: document.getElementById('towerType').value,
      location: document.getElementById('towerLocation').value.trim(),
      gps: {
        lat: parseFloat(document.getElementById('towerLat').value) || null,
        lng: parseFloat(document.getElementById('towerLng').value) || null
      },
      waterSource: document.getElementById('towerWaterSource').value,
      createdAt: new Date().toISOString()
    };
    try {
      await addTower(tower);
      alert('Tower saved!');
      e.target.reset();
      await populateTowerDropdowns();
    } catch(err) {
      alert('Error saving tower: ' + err);
    }
  });

  // Handle Daily Log form submit
  document.getElementById('dailyLogForm').addEventListener('submit', async e => {
    e.preventDefault();
    const log = {
      towerId: parseInt(document.getElementById('logTowerSelect').value),
      date: document.getElementById('logDate').value,
      sunlightHours: parseFloat(document.getElementById('sunlightHours').value) || 0,
      waterAdded: parseFloat(document.getElementById('waterAdded').value) || 0,
      biomassHarvested: parseFloat(document.getElementById('biomassHarvested').value) || 0,
      timestamp: new Date().toISOString()
    };
    try {
      await addLog(log);
      alert('Daily log saved!');
      e.target.reset();
      document.getElementById('logDate').valueAsDate = new Date();
      document.getElementById('logTowerSelect').value = '';
    } catch(err) {
      alert('Error saving log: ' + err);
    }
  });

  // Load and show logs in Log History table
  async function loadLogHistory() {
    const towerId = document.getElementById('filterTowerSelect').value;
    const fromDate = document.getElementById('filterFromDate').value;
    const toDate = document.getElementById('filterToDate').value;

    const logs = await getLogs({ towerId, fromDate, toDate });

    // Get all towers once for lookup
    const towers = await getAllTowers();
    const towerMap = {};
    towers.forEach(t => towerMap[t.id] = t);

    const tbody = document.getElementById('logTableBody');
    tbody.innerHTML = '';

    if (logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No logs found.</td></tr>';
      return;
    }

    logs.forEach(log => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${log.date}</td>
        <td>${towerMap[log.towerId] ? towerMap[log.towerId].name : 'Unknown'}</td>
        <td>${log.sunlightHours}</td>
        <td>${log.waterAdded}</td>
        <td>${log.biomassHarvested}</td>
        <td>
          <button class="btn-small" data-id="${log.id}" data-action="edit">Edit</button>
          <button class="btn-small" data-id="${log.id}" data-action="delete">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Attach event listeners to buttons
    tbody.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = Number(e.target.dataset.id);
        const action = e.target.dataset.action;
        if (action === 'delete') {
          if (confirm('Delete this log?')) {
            deleteLog(id).then(() => loadLogHistory());
          }
        } else if (action === 'edit') {
          loadLogForEdit(id);
        }
      });
    });
  }

  // Delete Log
  async function deleteLog(id) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('logs', 'readwrite');
      const store = tx.objectStore('logs');
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  // Load Log into Daily Log form for editing
  async function loadLogForEdit(id) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('logs', 'readonly');
      const store = tx.objectStore('logs');
      const req = store.get(id);
      req.onsuccess = () => {
        const log = req.result;
        if (!log) {
          alert('Log not found');
          reject('Not found');
          return;
        }
        showSection('dailyLogSection');
        document.getElementById('logTowerSelect').value = log.towerId;
        document.getElementById('logDate').value = log.date;
        document.getElementById('sunlightHours').value = log.sunlightHours;
        document.getElementById('waterAdded').value = log.waterAdded;
        document.getElementById('biomassHarvested').value = log.biomassHarvested;

        // Change form to update mode
        const form = document.getElementById('dailyLogForm');
        form.dataset.editingId = id;
        form.querySelector('button[type="submit"]').textContent = 'Update Daily Log';
        resolve();
      };
      req.onerror = () => reject(req.error);
    });
  }

  // Handle Daily Log update on submit if editing
  document.getElementById('dailyLogForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const editingId = form.dataset.editingId;
    if (editingId) {
      // Update existing log
      const updatedLog = {
        id: Number(editingId),
        towerId: parseInt(document.getElementById('logTowerSelect').value),
        date: document.getElementById('logDate').value,
        sunlightHours: parseFloat(document.getElementById('sunlightHours').value) || 0,
        waterAdded: parseFloat(document.getElementById('waterAdded').value) || 0,
        biomassHarvested: parseFloat(document.getElementById('biomassHarvested').value) || 0,
        timestamp: new Date().toISOString()
      };
      try {
        const tx = db.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        store.put(updatedLog);
        await tx.complete;
        alert('Daily log updated!');
        form.reset();
        form.removeAttribute('data-editing-id');
        form.querySelector('button[type="submit"]').textContent = 'Save Daily Log';
        showSection('logHistorySection');
        loadLogHistory();
      } catch(err) {
        alert('Error updating log: ' + err);
      }
    } else {
      // New log submission
      const log = {
        towerId: parseInt(document.getElementById('logTowerSelect').value),
        date: document.getElementById('logDate').value,
        sunlightHours: parseFloat(document.getElementById('sunlightHours').value) || 0,
        waterAdded: parseFloat(document.getElementById('waterAdded').value) || 0,
        biomassHarvested: parseFloat(document.getElementById('biomassHarvested').value) || 0,
        timestamp: new Date().toISOString()
      };
      try {
        await addLog(log);
        alert('Daily log saved!');
        form.reset();
        document.getElementById('logDate').valueAsDate = new Date();
        document.getElementById('logTowerSelect').value = '';
      } catch(err) {
        alert('Error saving log: ' + err);
      }
    }
  });

  // Init app
  (async () => {
    await openDB();
    await populateTowerDropdowns();
    document.getElementById('logDate').valueAsDate = new Date();
  })();
</script>

</body>
</html>
